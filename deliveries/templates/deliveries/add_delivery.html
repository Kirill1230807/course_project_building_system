{% extends "core/layout.html" %}
{% load static %}

{% block title %}Доставка матеріалів{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'pages/deliveries/add_delivery.css' %}">
    <link rel="stylesheet" href="{% static 'pages/core/components.css' %}">
{% endblock %}

{% block content %}

    <div class="delivery-container">

        <h1 class="page-title">Додати доставку матеріалів на дільницю</h1>

        {% if messages %}
            <div id="alert-container">
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" class="delivery-form">
            {% csrf_token %}

            <div class="form-section form-grid">

                <div class="form-group">
                    <label>Об’єкт:</label>
                    <select name="site_id" required>
                        <option value="">Оберіть об’єкт</option>
                        {% for s in sites %}
                            <option value="{{ s.0 }}"
                                    {% if s.0|stringformat:"s" == selected_site|stringformat:"s" %}selected{% endif %}>
                                {{ s.1 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Дільниця:</label>
                    <select name="section_id" required>
                        {% if selected_section %}
                            <option value="{{ selected_section }}" selected>Вибрана дільниця</option>
                        {% else %}
                            <option value="">Завантаження...</option>
                        {% endif %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Дата доставки:</label>
                    <input type="date" name="delivery_date" value="{{ delivery_date|date:'Y-m-d' }}">
                </div>

            </div>

            <div class="form-group textarea-group">
                <label>Примітка:</label>
                <textarea name="notes">{{ notes|default_if_none:'' }}</textarea>
            </div>

            <h2 class="materials-title">Матеріали</h2>

            <div id="materials-list">
                {% for mid, qty in filled_materials %}
                    <div class="material-row">

                        <select name="material_id" required>
                            {% for m in materials %}
                                <option value="{{ m.0 }}"
                                        {% if m.0 == mid %}selected{% endif %}>
                                    {{ m.1 }}
                                </option>
                            {% endfor %}
                        </select>

                        <input type="number" step="0.01" name="quantity"
                               placeholder="Кількість" value="{{ qty }}" required>

                        <button type="button" class="remove-row-btn"
                                onclick="removeMaterialRow(this)">×
                        </button>
                    </div>
                {% empty %}
                    <div class="material-row">
                        <select name="material_id" required>
                            {% for m in materials %}
                                <option value="{{ m.0 }}">{{ m.1 }}</option>
                            {% endfor %}
                        </select>

                        <input type="number" step="0.01" name="quantity"
                               placeholder="Кількість" required>

                        <button type="button" class="remove-row-btn"
                                onclick="removeMaterialRow(this)">×
                        </button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn-secondary" onclick="addMaterialRow()">+ Додати ще матеріал</button>
            <button type="submit" class="btn-primary submit-btn">Зберегти доставку</button>
        </form>
    </div>
    <script src="{% static 'deliveries/js/add_delivery.js' %}"></script>
{% endblock %}
