{% extends "core/layout.html" %}
{% load static %}
{% block content %}
    <div class="container mt-4">
        <h2>Додати доставку матеріалів на дільницю</h2>

        <!-- Повідомлення -->
        {% if messages %}
            <div id="alert-container" class="mt-3">
                {% for message in messages %}
                    <div class="alert
        {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}"
                         role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Об’єкт:</label>
                    <select name="site_id" class="form-select" required>
                        <option value="">Оберіть об’єкт</option>
                        {% for s in sites %}
                            <option value="{{ s.0 }}"
                                    {% if s.0|stringformat:"s" == selected_site|stringformat:"s" %}selected{% endif %}>
                                {{ s.1 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Дільниця:</label>
                    <select name="section_id" class="form-select" required>
                        {% if selected_section %}
                            <option value="{{ selected_section }}" selected>Вибрана дільниця</option>
                        {% else %}
                            <option value="">Завантаження...</option>
                        {% endif %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Дата доставки:</label>
                    <input type="date" name="delivery_date" class="form-control"
                           value="{{ delivery_date|date:'Y-m-d' }}">
                </div>
            </div>

            <div class="mb-3">
                <label>Примітка:</label>
                <textarea name="notes" class="form-control">{{ notes|default_if_none:'' }}</textarea>
            </div>

            <hr>
            <h4>Матеріали</h4>

            <div id="materials-list">
                {% for mid, qty in filled_materials %}
                    <div class="row mb-2 material-row">
                        <div class="col-md-5">
                            <select name="material_id" class="form-select" required>
                                {% for m in materials %}
                                    <option value="{{ m.0 }}">{{ m.1 }} (На складі: {{ m.2 }})</option>
                                {% endfor %}
                            </select>


                        </div>
                        <div class="col-md-3">
                            <input type="number" step="0.01" name="quantity" class="form-control"
                                   placeholder="Кількість" value="{{ qty }}">
                        </div>
                    </div>
                {% empty %}
                    <div class="row mb-2 material-row">
                        <div class="col-md-5">
                            <select name="material_id" class="form-select" required>
                                {% for m in materials %}
                                    <option value="{{ m.0 }}">{{ m.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" step="0.01" name="quantity" class="form-control"
                                   placeholder="Кількість" required>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <button type="button" onclick="addMaterialRow()">+ Додати ще матеріал</button>
            <button type="submit">Зберегти доставку</button>
        </form>
    </div>
    <link rel="stylesheet" href="{% static 'deliveries/css/add_delivery.css' %}">

    <script>
        // Автоматично приховати повідомлення через 4 секунди
        setTimeout(() => {
            const alertContainer = document.getElementById("alert-container");
            if (alertContainer) alertContainer.style.display = "none";
        }, 4000);

        // Додавання нового рядка матеріалу
        function addMaterialRow() {
            const container = document.getElementById('materials-list');
            const first = container.querySelector('.material-row');
            const clone = first.cloneNode(true);
            clone.querySelectorAll('input').forEach(input => input.value = '');
            container.appendChild(clone);
        }

        // Завантаження дільниць після вибору об’єкта
        document.addEventListener("DOMContentLoaded", function () {
            const siteSelect = document.querySelector("select[name='site_id']");
            const sectionSelect = document.querySelector("select[name='section_id']");

            siteSelect.addEventListener("change", function () {
                const siteId = this.value;
                sectionSelect.innerHTML = "<option>Завантаження...</option>";
                if (!siteId) return;

                fetch(`/deliveries/get-sections/${siteId}/`)
                    .then(response => response.json())
                    .then(data => {
                        sectionSelect.innerHTML = "";
                        if (data.sections.length === 0) {
                            sectionSelect.innerHTML = "<option value=''>Немає дільниць</option>";
                        } else {
                            data.sections.forEach(sec => {
                                const option = document.createElement("option");
                                option.value = sec[0];
                                option.textContent = sec[1];
                                sectionSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Помилка завантаження дільниць:", error);
                        sectionSelect.innerHTML = "<option value=''>Помилка</option>";
                    });
            });
        });
    </script>
{% endblock %}
